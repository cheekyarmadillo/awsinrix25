<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLACEHOLDER NAME — Interactive Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

  <style>
    :root { --bg:#f5f6f8; --surface:#fff; --text:#1f2937; --muted:#4b5563; --brand:#2563eb; --nav:#0f172a; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:14px 22px; background:var(--nav); color:#e5e7eb; position:sticky; top:0; z-index:1000; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; }
    .logo { width:20px; height:20px; border-radius:999px; background:#94a3b8; display:inline-block; }
    .nav { display:flex; gap:22px; }
    .nav a { color:#e5e7eb; text-decoration:none; }
    .nav a:hover { text-decoration:underline; }

    .wrap { max-width:1100px; margin:18px auto; padding:0 16px; }
    h1 { font-size:32px; margin:10px 0 14px; }
    #map { height:72vh; width:100%; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); }

    .legend {
      background: #fff; padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
      font-size: 13px; line-height: 1.3;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .swatch { width:16px; height:12px; border-radius:3px; border:1px solid #e5e7eb; }

    .hint { margin:10px 2px 0; color:var(--muted); font-size:14px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <span>PLACEHOLDER NAME</span>
    </div>
    <nav class="nav" aria-label="Top navigation">
      <a href="/">Home</a>
      <a href="/report">Report Issue</a>
      <a href="/map" aria-current="page">Interactive Map</a>
    </nav>
  </header>

  <main class="wrap">
    <h1>Interactive Map</h1>
    <div id="map" role="application" aria-label="Heatmap of verified road issues"></div>
    <p class="hint">
      Colors show <b>verified</b> issue density per cell: White (0), Yellow (1), Orange (2–3), Red (4+).
      Unverified reports appear as small gray dots and are not counted.
    </p>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script>
    // --- 1) Base map (centered near SCU) ---
    const map = L.map('map', { scrollWheelZoom: true }).setView([37.3496, -121.9381], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 2) Demo data (replace with your backend later) ---
    // Each report: { lat, lng, verified: boolean, desc?: string }
    const reports = [
      // Verified
      { lat: 37.3496, lng: -121.9381, verified: true,  desc: 'Pothole near campus' },
      { lat: 37.3520, lng: -121.9300, verified: true,  desc: 'Cracked asphalt' },
      { lat: 37.3470, lng: -121.9450, verified: true,  desc: 'Deep pothole' },
      { lat: 37.3360, lng: -121.9300, verified: true,  desc: 'Edge break' },
      { lat: 37.3550, lng: -121.9550, verified: true,  desc: 'Alligator cracking' },
      // Cluster a few more to trigger orange/red bins
      { lat: 37.3498, lng: -121.9380, verified: true },
      { lat: 37.3494, lng: -121.9383, verified: true },
      { lat: 37.3492, lng: -121.9385, verified: true },

      // Unverified (shown as gray dots, not counted)
      { lat: 37.3412, lng: -121.9285, verified: false, desc: 'Awaiting AI check' },
      { lat: 37.3465, lng: -121.9521, verified: false, desc: 'Awaiting AI check' }
    ];

    // --- 3) Grid-based aggregation for VERIFIED ONLY ---
    // Cell size in degrees (~0.005 ~= ~550m N-S). Adjust to tune granularity.
    const CELL = 0.005;

    // Helper to get grid key & polygon bounds for a lat/lng
    function gridKey(lat, lng) {
      const rlat = Math.floor(lat / CELL) * CELL;
      const rlng = Math.floor(lng / CELL) * CELL;
      return `${rlat.toFixed(5)},${rlng.toFixed(5)}`;
    }
    function cellPolygonFromKey(key) {
      const [rlat, rlng] = key.split(',').map(Number);
      const sw = [rlat, rlng];
      const se = [rlat, rlng + CELL];
      const ne = [rlat + CELL, rlng + CELL];
      const nw = [rlat + CELL, rlng];
      return [nw, ne, se, sw]; // Leaflet polygon expects [lat,lng] ring
    }

    // Count verified reports per cell
    const counts = new Map();
    for (const r of reports) {
      if (!r.verified) continue;
      const key = gridKey(r.lat, r.lng);
      counts.set(key, (counts.get(key) || 0) + 1);
    }

    // --- 4) Color scale (discrete) ---
    function bucketColor(n) {
      if (!n || n <= 0) return '#ffffff';     // 0 (white)
      if (n === 1)        return '#fde047';   // 1 (yellow  — Tailwind amber-300-ish)
      if (n <= 3)         return '#fb923c';   // 2–3 (orange)
      return '#ef4444';                        // 4+ (red)
    }

    // --- 5) Draw grid polygons for cells present in data + a few neighbor cells (optional) ---
    // We’ll draw only cells that have at least one verified count to keep it light.
    counts.forEach((n, key) => {
      const poly = L.polygon(cellPolygonFromKey(key), {
        color: '#e5e7eb',        // thin border
        weight: 1,
        fillColor: bucketColor(n),
        fillOpacity: n > 0 ? 0.72 : 0.0
      }).addTo(map);

      poly.bindPopup(`<b>${n}</b> verified issue${n>1?'s':''} in this area`);
    });

    // --- 6) Plot UNVERIFIED markers (small gray dots) ---
    const unverifiedIcon = L.divIcon({
      className: 'unverified-dot',
      html: '<div style="width:8px;height:8px;border-radius:999px;background:#6b7280;opacity:.8;border:1px solid #fff;"></div>',
      iconSize: [8,8],
      iconAnchor: [4,4]
    });

    reports.filter(r => !r.verified).forEach(r => {
      L.marker([r.lat, r.lng], { icon: unverifiedIcon })
        .addTo(map)
        .bindPopup(`<b>Unverified report</b><br>${r.desc || 'Pending AI verification'}`);
    });

    // --- 7) Legend ---
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px;">Legend</div>
        <div class="row"><span class="swatch" style="background:#ffffff;"></span> No issues</div>
        <div class="row"><span class="swatch" style="background:#fde047;"></span> 1 issue</div>
        <div class="row"><span class="swatch" style="background:#fb923c;"></span> 2–3 issues</div>
        <div class="row"><span class="swatch" style="background:#ef4444;"></span> 4+ issues</div>
        <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0;">
        <div class="row"><span class="swatch" style="background:#6b7280;"></span> Unverified (dot)</div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
